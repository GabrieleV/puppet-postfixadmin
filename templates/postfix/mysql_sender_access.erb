#
#  MANAGED BY PUPPET
#     do not edit this file manualy
#
# File: mysql_sender_access
#
# Purpose:
#  get a list of login names (separated by space) that are allowed to send
#  mail for the query
#
#  supports + delimiter for username (user+something@domain) 
#  supports @domain query for wildcard
#  supports alias domains
#
#  use this in postfix for smtpd_sender_login_maps
#
# restrictions:
# alias of aliases are not supported.
#

user     = <%= @dbuser %>
password = <%= @dbpass %>
hosts    = <%= @hosts.join(' ') %>
dbname   = <%= @dbname %>


query    = select distinct GROUP_CONCAT( REGEXP_REPLACE(goto, '[+].*@','@') SEPARATOR ' ') as goto from (

            SELECT goto FROM alias 
            WHERE ( address='%s'
                    OR    address like replace('%s', '@', '+%%@')
                  ) and active=1
            UNION
            SELECT goto FROM (
              select REGEXP_REPLACE(address, CONCAT('@',target_domain,'$'), CONCAT('@',alias_domain)) as address, goto
              from alias a, alias_domain d
              where a.domain=d.target_domain and d.active=1 and a.active=1
            ) as aliasdom
            WHERE  address='%s'
            OR    address like replace('%s', '@', '+%%@')
<% if @allow_account_as_sender -%>
            UNION
            SELECT '%s' as goto
<% end -%>
          ) as a 
          GROUP by 'all'

